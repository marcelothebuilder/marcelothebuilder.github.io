<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>Marcelo Paixão Resende - Talking about code</title>
    <meta name="description" content="Marcelo Paixão Resende personal blog. Talking about code, software development, Java, Javascript, Node and emerging technologies" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />


    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <!-- Customisation  -->
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />


    <!-- <meta content="Title" property="og:title">
    <meta content="Type" property="og:type">
    <meta content="Image" property="og:image">
    <meta content="URL" property="og:url">
    <meta content="Site Name" property="og:site_name">
    <meta content="Description" property="og:description">
    <meta content="Time" property="article:published_time">
    <meta content="Author" property="article:author">
    <meta content="Category" property="article:section">
    <meta content="Tag" property="article:tag"> -->


    <!-- og -->
    
    


    <meta content="Talking about code" property="og:site_name">

    
      <meta content="Marcelo Paixão Resende" property="og:title">
    

    
      <meta content="article" property="og:type">
    

    
      <meta content="Talking about code" property="og:description">
    

    
      <meta content="https://marcelothebuilder.github.io/" property="og:url">
    
    

    
      <meta content="https://marcelothebuilder.github.io/assets/images/main-cover.jpeg" property="og:image">
      <meta content="1125" property="og:image:width">
      <meta content="750" property="og:image:height">
    

    <!-- og end -->


    <!-- twitter -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="marcelopaixaor">
    <meta name="twitter:creator" content="marcelopaixaor">

    
      <meta name="twitter:title" content="Marcelo Paixão Resende">
    


    
      <meta name="twitter:url" content="https://marcelothebuilder.github.io/">
    

    
      <meta name="twitter:description" content="Talking about code">
    


    
      <meta name="twitter:image:src" content="https://marcelothebuilder.github.io/assets/images/main-cover.jpeg">
    

    <!-- twitter -->

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-106123669-1', 'auto');
      ga('send', 'pageview');

    </script>
</head>
<body class="home-template">

    <header class="main-header coder__main-header  coder__main-header--limited  " style="background-image: url(assets/images/main-cover.jpeg) ">
    <nav class="main-nav overlay clearfix">
            
        <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
    </nav>
    <div class="vertical">
        <div class="main-header-content inner coder__main-header-content">
            <h1 class="page-title">Marcelo Paixão Resende</h1>
            <h2 class="page-description">
                 Talking about code. 
            </h2>

            
            <div class="coder__main-header-content_about">
              <a href='/about.html'> Who is Marcelo? </a>
            </div>
            
        </div>
    </div>
    <a class="scroll-down icon-arrow-left" href="#content" data-offset="-45"><span class="hidden">Scroll Down</span></a>
</header>


<main id="content" class="content" role="main">


    <div class="extra-pagination inner">
        <nav class="pagination" role="pagination">
    
    <span class="page-number"> Page 1 of 1 </span>
     
</nav>
    </div>

    

    <article class="post">
        <header class="post-header">
            <h2 class="post-title"><a href="/elasticsearch/nosql/2018/01/21/ElasticSearch-Pagination-by-document-creation-date.html">ElasticSearch: Pagination by document creation date</a></h2>
        </header>
        <section class="post-content">
          <!-- <p>It’s been a while. Kept you waiting, huh?</p>

<p>Pagination is not an easy task. There are a lot of implementations that are simply wrong, returning pages missing entries when there’s insertion/updates between queries or sufferring from serious performance issues.</p>

<p>With ElasticSearch, we have multiple ways of implementing pagination. The <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.5/search-request-scroll.html">Scroll API</a> is a good feature when you need to fetch multiple documents inside a task, but it won’t save you when you need to work with pages in a stateless manner (maybe there’s a front-end client consuming your api).</p>

<p>Real case: I needed to search for documents using a task that would run every N minutes. At the end of every search, I would save a “checkpoint”, something indicating where I last stopped so that the next iteration could resume from it.</p>

<h2 id="pagination-with-a-creation-date-field">Pagination with a “creation date” field</h2>

<p>Supposing we have the following documents stored in an index:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="p">[</span>
  <span class="p">{</span>
    <span class="nt">&quot;creationDate&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-01-21T19:51:42.840Z&quot;</span><span class="p">,</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Marcelo&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;creationDate&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-01-21T19:51:42.840Z&quot;</span><span class="p">,</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sarah&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;creationDate&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-01-21T19:51:42.840Z&quot;</span><span class="p">,</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Yasmin&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;creationDate&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-01-21T20:51:42.840Z&quot;</span><span class="p">,</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Julia&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;creationDate&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-01-21T20:51:42.840Z&quot;</span><span class="p">,</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Nicolly&quot;</span>
  <span class="p">}</span>
<span class="p">]</span></code></pre></figure>

<p>In our example, we will search through these documents with a page size of <strong>2</strong>. We want to find all those <strong>5</strong> documents, ordered by their creation date, meaning that when new documents are inserted we can fetch only the new ones.</p>

<h3 id="episode-1-the-naïve-approach">Episode 1: The naïve approach</h3>

<p>We can structure our query in a way that documents are ordered by their <code>creationDate</code> and for every iteration we would store the <strong>last</strong> document <code>creationDate</code>. This is what our query will look like (with the GET /my_index/_search ommitted):</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="p">{</span>
  <span class="nt">&quot;size&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nt">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;range&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;_name&quot;</span><span class="p">:</span> <span class="s2">&quot;This block won&#39;t be present in the first page request (since we don&#39;t have the last creationDate reference!)&quot;</span><span class="p">,</span>
      <span class="nt">&quot;creationDate&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;gt&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-01-21T19:51:42.840Z&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nt">&quot;sort&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;creationDate&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;order&quot;</span><span class="p">:</span> <span class="s2">&quot;asc&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span></code></pre></figure>

<p>And this is the result after 3 iterations/pages (only _source included, the other metadata is not needed for now):</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="p">[{</span>
  <span class="nt">&quot;_source&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;creationDate&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-01-21T19:51:42.840Z&quot;</span><span class="p">,</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sarah&quot;</span>
  <span class="p">}</span>
<span class="p">},</span> <span class="p">{</span>
  <span class="nt">&quot;_source&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;creationDate&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-01-21T19:51:42.840Z&quot;</span><span class="p">,</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Marcelo&quot;</span>
  <span class="p">}</span>
<span class="p">},</span> <span class="p">{</span>
  <span class="nt">&quot;_source&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;creationDate&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-01-21T20:51:42.840Z&quot;</span><span class="p">,</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Julia&quot;</span>
  <span class="p">}</span>
<span class="p">},</span> <span class="p">{</span>
  <span class="nt">&quot;_source&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;creationDate&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-01-21T20:51:42.840Z&quot;</span><span class="p">,</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Nicolly&quot;</span>
  <span class="p">}</span>
<span class="p">}]</span></code></pre></figure>

<p>We only got 4 results!</p>

<p>Where is <strong>Yasmin</strong>?</p>

<p>Turns out that after we got <strong>Sarah</strong> and <strong>Marcelo</strong>, our next query asked for a page with 2 results returning documents created after the first query’s last document (<strong>Marcelo</strong>) with a <code>creationDate</code> greater than “2018-01-21T19:51:42.840Z”.</p>

<p>The problem: Yasmin was also created in that same instant.</p>

<p><strong>Documents created in the same instant makes this approach unpredictable and not always accurate.</strong></p>

<p><strong>Worse yet:</strong> The problem can persist for a long time before someone notice it, if they ever do.</p>

<h3 id="episode-2-the-right-approach">Episode 2: The right approach</h3>

<p>Starting with version 5.0, ElasticSearch provides us a nice and realiable way to address this issue: the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.0/search-request-search-after.html">Search After</a> parameter. Quoting the docs:</p>

<blockquote>
  <p>The search_after parameter circumvents this problem by providing a live cursor. The idea is to use the results from the previous page to help the retrieval of the next page.</p>
</blockquote>

<p>and</p>

<blockquote>
  <p>search_after is not a solution to jump freely to a random page but rather to scroll many queries in parallel. It is very similar to the scroll API but unlike it, the search_after parameter is stateless, it is always resolved against the latest version of the searcher.</p>
</blockquote>

<p>We can change the sort in out last query to include the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.0/mapping-uid-field.html">_uid</a> field, unique to every document in that specific index.</p>

<p>Then, starting from the first query, we must include a search_after parameter that will include the <strong>creationDate</strong> and <strong>_uid</strong> from the last document in the previous query. Those values are returned with every match in the <code>sort</code> block:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="p">{</span>
  <span class="nt">&quot;_source&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;creationDate&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-01-21T20:51:42.840Z&quot;</span><span class="p">,</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Julia&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;sort&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="mi">1516564302840</span><span class="p">,</span>
    <span class="s2">&quot;type#AWEagzSzwHnysW-7Ulq9&quot;</span>
  <span class="p">]</span>
<span class="p">}</span></code></pre></figure>

<p>So, when finding all documents created after <strong>Julia</strong>, we would use the following query:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="p">{</span>
  <span class="nt">&quot;size&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nt">&quot;search_after&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="mi">1516564302840</span><span class="p">,</span>
    <span class="s2">&quot;type#AWEagzSzwHnysW-7Ulq9&quot;</span>
  <span class="p">],</span>
  <span class="nt">&quot;sort&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;creationDate&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;order&quot;</span><span class="p">:</span> <span class="s2">&quot;asc&quot;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">&quot;_uid&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;order&quot;</span><span class="p">:</span> <span class="s2">&quot;asc&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span></code></pre></figure>

<p><strong>That way we can assure that we can find all the current 5 documents and all future documents that will be inserted.</strong></p>

<p>There’s just one caveat: Our application <strong>must not</strong> insert documents with a <code>creationDate</code> lower than the last one.</p>

<h2 id="other-dbms">Other DBMS</h2>

<p>This solution can also be “ported” to other DBMS easily.</p>

<p>For example, I found that solution when looking for a similar way that we used to do with <a href="https://couchdb.apache.org/">CouchDB</a> keys and views.</p>

<p>In this case, it is almost identical.</p>

<p>It would look like this with SQL databases when you are not using an auto-incremented primary key:</p>

<p>First page query:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span></span><span class="k">select</span>
	<span class="n">uuid</span><span class="p">,</span>
	<span class="n">creation_date</span>
<span class="k">from</span>
	<span class="n">your_table</span>
<span class="k">order</span> <span class="k">by</span>
	<span class="n">creation_date</span> <span class="k">asc</span><span class="p">,</span>
	<span class="n">uuid</span> <span class="k">asc</span>
<span class="k">limit</span> <span class="mi">10</span></code></pre></figure>

<p>Second page query:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span></span><span class="k">select</span>
	<span class="n">uuid</span><span class="p">,</span>
	<span class="n">creation_date</span>
<span class="k">from</span>
	<span class="n">your_table</span>
<span class="k">where</span>
  <span class="c1">-- the document is indeed created later than the last one</span>
	<span class="n">creation_date</span> <span class="o">&gt;</span> <span class="p">:</span><span class="n">last_page_row_creation_date</span>
  <span class="c1">-- OR it was created at the same time, but wasn&#39;t included in the last page because of it&#39;s limit clause</span>
		<span class="k">or</span> <span class="n">creation_date</span> <span class="o">=</span> <span class="p">:</span><span class="n">last_page_row_creation_date</span> <span class="k">and</span> <span class="n">uuid</span> <span class="o">&gt;</span> <span class="p">:</span><span class="n">last_page_row_uuid</span>
<span class="k">order</span> <span class="k">by</span>
	<span class="n">creation_date</span> <span class="k">asc</span><span class="p">,</span>
	<span class="n">uuid</span> <span class="k">asc</span>
<span class="k">limit</span> <span class="mi">10</span></code></pre></figure>

<h2 id="conclusion">Conclusion</h2>

<p>This is a safe way of implementing pagination using ElasticSearch when we plan to iterate through the results in a stateless manner. It is much valuable when using ElasticSearch with endlessy running tasks or when it is used as your primary database.</p>

<p>Good luck!</p>
 -->
          <!-- <section class="post-excerpt"> -->
          <!--excerpt disabled -->
            <p>It’s been a while. Kept you waiting, huh?</p>

 <a class="read-more" href="/elasticsearch/nosql/2018/01/21/ElasticSearch-Pagination-by-document-creation-date.html">Read more &raquo;</a>
        </section>
        <footer class="post-meta">
            
                <img class="author-thumb" src="/assets/images/profile.png" alt="Author's profile picture" nopin="nopin" />
                Marcelo Paixão Resende
            
            
                on ElasticSearch and NoSQL
            
            <time class="post-date" datetime="2018-01-21">
                21 Jan 2018
            </time>
        </footer>
    </article>

    

    <article class="post">
        <header class="post-header">
            <h2 class="post-title"><a href="/java/jpa/2017/09/11/jpa-post.html">JPA Criteria: Invalid SQL with IN predicate</a></h2>
        </header>
        <section class="post-content">
          <!-- <p>JPA Criteria is awesome when you need to compose complex queries from multiple blocks, but it can cause a lot of troubles when the underlying SQL code fails to check some obvious scenarios.</p>

<h2 id="the-concept">The concept</h2>
<p>When dealing with Java <code>List</code>s, we can almost always assume (if written correctly) that code will work as expected with empty lists if we respect the contract (don’t pass <code>null</code> as a parameter!).</p>

<p>Imagine the following code:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">persons</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>

<span class="kd">static</span> <span class="o">{</span>
	<span class="n">persons</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="mi">1L</span><span class="o">));</span>
	<span class="n">persons</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="mi">2L</span><span class="o">));</span>
	<span class="n">persons</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="mi">3L</span><span class="o">));</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">personsQueryOne</span> <span class="o">=</span> <span class="n">findPersonsByIds</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">));</span>
	<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">personsQueryOne</span><span class="o">);</span>
	<span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">personsQueryTwo</span> <span class="o">=</span> <span class="n">findPersonsByIds</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">());</span>
	<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">personsQueryTwo</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="nf">findPersonsByIds</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">idsList</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">persons</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">filter</span><span class="o">(</span><span class="n">person</span> <span class="o">-&gt;</span> <span class="n">idsList</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="na">getId</span><span class="o">())).</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
<span class="o">}</span></code></pre></figure>

<p>We have:</p>
<ul>
  <li>A static list of persons;</li>
  <li>A method that searches the list of persons when provided with a list of ids.</li>
</ul>

<p>This is the console output:</p>
<pre><code>[Person [id=1], Person [id=2]]
[]
</code></pre>

<p>Nothing special, right? If we pass an empty list of ids, the method won’t have anything to search for!</p>

<h2 id="the-problem">The problem</h2>

<p>Now, lets imagine the same kind of situation, but working with:</p>
<ul>
  <li>JPA 2.1 with Criteria;</li>
  <li>Hibernate as JPA provider;</li>
  <li>Postgres as database.</li>
</ul>

<p>The following query should search for the <code>Person</code> entity that matches a list of ids (but we are bad boys and provided an empty <code>List</code>):</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">CriteriaBuilder</span> <span class="n">criteriaBuilder</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>
<span class="n">CriteriaQuery</span><span class="o">&lt;</span><span class="n">MyEntity</span><span class="o">&gt;</span> <span class="n">criteriaQuery</span> <span class="o">=</span> <span class="n">criteriaBuilder</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">MyEntity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">Root</span><span class="o">&lt;</span><span class="n">MyEntity</span><span class="o">&gt;</span> <span class="n">myEntity</span> <span class="o">=</span> <span class="n">criteriaQuery</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">MyEntity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">Predicate</span> <span class="n">inPredicate</span> <span class="o">=</span> <span class="n">myEntity</span><span class="o">.</span><span class="na">in</span><span class="o">(</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;());</span> <span class="c1">// an empty arraylist!</span>
<span class="n">criteriaQuery</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">inPredicate</span><span class="o">);</span>
<span class="n">TypedQuery</span><span class="o">&lt;</span><span class="n">MyEntity</span><span class="o">&gt;</span> <span class="n">typedQuery</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">criteriaQuery</span><span class="o">);</span>
<span class="n">typedQuery</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span></code></pre></figure>

<p>The call to <code>typedQuery.getResultList()</code> should return an empty resultset. The generated SQL is (attention to the where clause):</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span></span><span class="k">select</span>
	<span class="n">person0_</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id1_0_</span><span class="p">,</span>
	<span class="n">person0_</span><span class="p">.</span><span class="n">name</span> <span class="k">as</span> <span class="n">name2_0_</span><span class="p">,</span>
	<span class="n">person0_</span><span class="p">.</span><span class="k">type</span> <span class="k">as</span> <span class="n">type3_0_</span>
<span class="k">from</span>
	<span class="n">person</span> <span class="n">person0_</span>
<span class="k">where</span>
	<span class="n">person0_</span><span class="p">.</span><span class="n">id</span> <span class="k">in</span><span class="p">()</span></code></pre></figure>

<p>And the execution causes:</p>
<pre><code>javax.persistence.PersistenceException: org.hibernate.exception.SQLGrammarException: could not extract ResultSet
...
Caused by: org.postgresql.util.PSQLException: ERROR: syntax error at or near ")"
  Posição: 127
	at org.postgresql.core.v3.QueryExecutorImpl.receiveErrorResponse(QueryExecutorImpl.java:2477)
	...
</code></pre>

<p>Indeed, the generated SQL is invalid. One of the approaches (and the most performatic one) would be to check for empty <code>List</code>s all the time, but we may end up with a lot of boilerplate code.</p>

<h2 id="solutions">Solution(s)</h2>

<p>We can solve this problem with creative ways, and I came up with two, depending on the situation.</p>

<h3 id="1---create-your-own-in-method-or-utility">#1 - Create your own IN method or utility</h3>

<p>This one is easy: instead of using <code>Expression#in(Collection)</code>, we can create a method that will handle the empty collection case for us, returning a <code>Predicate</code>:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">private</span> <span class="n">Predicate</span> <span class="nf">in</span><span class="o">(</span><span class="n">Expression</span><span class="o">&lt;?&gt;</span> <span class="n">entityValue</span><span class="o">,</span> <span class="n">Collection</span><span class="o">&lt;?&gt;</span> <span class="n">valuesToMatch</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">valuesToMatch</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">valuesToMatch</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">falsyCondition</span><span class="o">();</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="n">entityValue</span><span class="o">.</span><span class="na">in</span><span class="o">(</span><span class="n">valuesToMatch</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="n">Predicate</span> <span class="nf">falsyCondition</span><span class="o">()</span> <span class="o">{</span>
	<span class="n">CriteriaBuilder</span> <span class="n">criteriaBuilder</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>
	<span class="k">return</span> <span class="n">criteriaBuilder</span><span class="o">.</span><span class="na">isTrue</span><span class="o">(</span><span class="n">criteriaBuilder</span><span class="o">.</span><span class="na">literal</span><span class="o">(</span><span class="kc">false</span><span class="o">));</span>
<span class="o">}</span></code></pre></figure>

<p>What’s happenning here: If <code>List.isEmpty() == true</code>, we return an condition that is <strong>always</strong> false. In this case: <code>true=false</code>.</p>

<p>Here’s the relevant part using this code:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">Predicate</span> <span class="n">inPredicate</span> <span class="o">=</span> <span class="n">in</span><span class="o">(</span><span class="n">personEntity</span><span class="o">,</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;());</span>
<span class="n">criteriaQuery</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">inPredicate</span><span class="o">);</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">criteriaQuery</span><span class="o">).</span><span class="na">getResultList</span><span class="o">();</span></code></pre></figure>

<p>And here is the generated SQL (? is a placeholder for <code>false</code>):</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span></span><span class="k">select</span>
	<span class="n">person0_</span><span class="p">.</span><span class="n">id</span> <span class="k">as</span> <span class="n">id1_0_</span><span class="p">,</span>
	<span class="n">person0_</span><span class="p">.</span><span class="n">name</span> <span class="k">as</span> <span class="n">name2_0_</span><span class="p">,</span>
	<span class="n">person0_</span><span class="p">.</span><span class="k">type</span> <span class="k">as</span> <span class="n">type3_0_</span>
<span class="k">from</span>
	<span class="n">person</span> <span class="n">person0_</span>
<span class="k">where</span>
	<span class="o">?=</span> <span class="k">true</span></code></pre></figure>

<p>No more exceptions!</p>

<h3 id="2---decorator-pattern">#2 - Decorator pattern</h3>

<p>The solution #1 is great when you have something like a <code>AbstractRepository</code> or <code>AbstractDAO</code> that you can put the created reusable method. But when that’s not an option, we can come up with a <code>Decorator</code> that will only be applied to the <code>Path</code> or <code>Expression</code> that we are checking for matches in the list.</p>

<p>First, a new class must be created:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SafeInDecorator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">Expression</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="n">CriteriaBuilder</span> <span class="n">criteriaBuilder</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Expression</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">decorated</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">SafeInDecorator</span><span class="o">(</span><span class="n">CriteriaBuilder</span> <span class="n">criteriaBuilder</span><span class="o">,</span> <span class="n">Expression</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">decorated</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">criteriaBuilder</span> <span class="o">=</span> <span class="n">criteriaBuilder</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">decorated</span> <span class="o">=</span> <span class="n">decorated</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">Predicate</span> <span class="nf">in</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;?&gt;</span> <span class="n">values</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">values</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
			<span class="k">return</span> <span class="n">falsyCondition</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">decorated</span><span class="o">.</span><span class="na">in</span><span class="o">(</span><span class="n">values</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">Predicate</span> <span class="nf">in</span><span class="o">(</span><span class="n">Object</span><span class="o">...</span> <span class="n">values</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">in</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">values</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="n">Predicate</span> <span class="nf">falsyCondition</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">criteriaBuilder</span><span class="o">.</span><span class="na">isTrue</span><span class="o">(</span><span class="n">criteriaBuilder</span><span class="o">.</span><span class="na">literal</span><span class="o">(</span><span class="kc">false</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">Predicate</span> <span class="nf">isNull</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">decorated</span><span class="o">.</span><span class="na">isNull</span><span class="o">();</span>
	<span class="o">}</span>

  <span class="cm">/** all other methods must be implemented delegating to the decorated object **/</span>
<span class="o">}</span></code></pre></figure>

<p>Then we can decorate the entity <code>Path</code> object and use the <code>#in(Collection)</code> method that adheres to our contract:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">Root</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">personEntity</span> <span class="o">=</span> <span class="n">criteriaQuery</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">Person</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">Expression</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">personDecorated</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SafeInDecorator</span><span class="o">&lt;&gt;(</span><span class="n">criteriaBuilder</span><span class="o">,</span> <span class="n">personEntity</span><span class="o">);</span>
<span class="n">Predicate</span> <span class="n">inPredicate</span> <span class="o">=</span> <span class="n">personDecorated</span><span class="o">.</span><span class="na">in</span><span class="o">(</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;());</span></code></pre></figure>

<p>No more exceptions!²</p>

<h2 id="conclusion">Conclusion</h2>

<p>In the end, you should pick the option that suits better your project’s situation.</p>

<p>It would be nice to have the <strong>#1</strong> solution in an <code>AbstractRepository</code> where it can be reused in subclasses. But if this problem was discovered when that’s not an option, the <strong>#2</strong> solution also solves the problem and is less intrusive to the class hierarchy.</p>

<p>Which one to choose is up to you!</p>
 -->
          <!-- <section class="post-excerpt"> -->
          <!--excerpt disabled -->
            <p>JPA Criteria is awesome when you need to compose complex queries from multiple blocks, but it can cause a lot of troubles when the underlying SQL code fails to check some obvious scenarios.</p>

 <a class="read-more" href="/java/jpa/2017/09/11/jpa-post.html">Read more &raquo;</a>
        </section>
        <footer class="post-meta">
            
                <img class="author-thumb" src="/assets/images/profile.png" alt="Author's profile picture" nopin="nopin" />
                Marcelo Paixão Resende
            
            
                on Java and JPA
            
            <time class="post-date" datetime="2017-09-11">
                10 Sep 2017
            </time>
        </footer>
    </article>

    

    <article class="post">
        <header class="post-header">
            <h2 class="post-title"><a href="/2017/09/10/yet-another-technology-blog.html">Yet another technology blog</a></h2>
        </header>
        <section class="post-content">
          <!-- <p>My name is Marcelo and I’m a software developer currently living in <a href="https://en.wikipedia.org/wiki/Uberl%C3%A2ndia" target="_blank">Uberlândia, Brazil</a>.</p>

<p>I’ve been developing software for fun since i was fifteen. A few years later, I realized that programming was something that I already had been doing with a quality that could be used professionally, and then I started working in the industry.</p>

<p>Throughout the years I had contact with <strong>Perl</strong>, <strong>C#</strong>, <strong>C++</strong>, <strong>Java</strong> and <strong>Javascript</strong> (Client &amp; Server-side). Today I work heavily with <strong>Java</strong> and <strong>Javascript</strong> enterprisely. Currently I’m anxious to have some fun with Typescript (Angular) and Kotlin.</p>

<p>I’ve been flirting with the idea of creating a blog for too long, but time had been crushing my dreams. I hope this introduction to be just the front page to a lot of useful and interesting posts.</p>
 -->
          <!-- <section class="post-excerpt"> -->
          <!--excerpt disabled -->
            <p>My name is Marcelo and I’m a software developer currently living in <a href="https://en.wikipedia.org/wiki/Uberl%C3%A2ndia" target="_blank">Uberlândia, Brazil</a>.</p>

 <a class="read-more" href="/2017/09/10/yet-another-technology-blog.html">Read more &raquo;</a>
        </section>
        <footer class="post-meta">
            
                <img class="author-thumb" src="/assets/images/profile.png" alt="Author's profile picture" nopin="nopin" />
                Marcelo Paixão Resende
            
            
            <time class="post-date" datetime="2017-09-10">
                10 Sep 2017
            </time>
        </footer>
    </article>

    

    <nav class="pagination" role="pagination">
    
    <span class="page-number"> Page 1 of 1 </span>
     
</nav>

</main>


    <footer class="site-footer clearfix">
      <section class="copyright">
        <a href="https://marcelothebuilder.github.io/">Marcelo Paixão Resende</a> &copy;
              2018 &bull; All rights reserved.
      </section>

      <section class="category-link">
        <a href="https://marcelothebuilder.github.io/categories">List posts by category</a>
      </section>

      <section class="poweredby">Made with Jekyll using
        <a href="http://github.com/rosario/kasper">Kasper theme</a>
      </section>
    </footer>

    <script type="text/javascript" src="/assets/js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>
</body>
</html>
